<!DOCTYPE html>
<html>
  <head>
    <title>Test Approve Function</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      .btn {
        padding: 10px 20px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px;
      }
      .result {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin: 15px 0;
        border-left: 4px solid #007bff;
      }
      .success {
        border-left-color: #28a745;
      }
      .error {
        border-left-color: #dc3545;
      }
      pre {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 3px;
      }
    </style>
  </head>
  <body>
    <h1>ðŸ”§ Test Approve Function</h1>

    <div>
      <button class="btn" onclick="testLogin()">ðŸ‘¤ Test Login First</button>
      <button class="btn" onclick="testApprove()">
        âœ… Test Approve Function
      </button>
      <button class="btn" onclick="checkRequests()">
        ðŸ“‹ Check Request Status
      </button>
    </div>

    <div id="results"></div>

    <script>
      function showResult(title, content, isSuccess = true) {
        const results = document.getElementById("results");
        const className = isSuccess ? "success" : "error";
        const timestamp = new Date().toLocaleTimeString();

        results.innerHTML =
          `
                <div class="result ${className}">
                    <strong>[${timestamp}] ${title}</strong>
                    <pre>${JSON.stringify(content, null, 2)}</pre>
                </div>
            ` + results.innerHTML;
      }

      async function testLogin() {
        try {
          // First try to access the quick login
          const response = await fetch("quick_login.php");
          const text = await response.text();

          if (response.ok) {
            showResult(
              "âœ… Login Test",
              {
                message: "Quick login page accessible",
                status: response.status,
              },
              true
            );

            // Also try to check session status
            const sessionResponse = await fetch(
              "../../backend/api/get_dashboard_metrics.php"
            );
            const sessionData = await sessionResponse.json();

            if (sessionResponse.ok) {
              showResult(
                "âœ… Session Test",
                { message: "Admin session appears active", data: sessionData },
                true
              );
            } else {
              showResult(
                "âŒ Session Test",
                {
                  message: "Session might not be active",
                  status: sessionResponse.status,
                },
                false
              );
            }
          } else {
            showResult(
              "âŒ Login Test",
              {
                message: "Quick login not accessible",
                status: response.status,
              },
              false
            );
          }
        } catch (error) {
          showResult("âŒ Login Test Error", { error: error.message }, false);
        }
      }

      async function testApprove() {
        try {
          // First get a request to approve
          const requestsResponse = await fetch(
            "../../backend/api/get_recent_requests.php"
          );
          const requestsData = await requestsResponse.json();

          if (
            requestsData.success &&
            requestsData.requests &&
            requestsData.requests.length > 0
          ) {
            const testRequest = requestsData.requests[0];
            showResult(
              "ðŸ“‹ Found Request to Test",
              { id: testRequest.id, status: testRequest.status },
              true
            );

            // Try to approve it
            const approveResponse = await fetch(
              "../../backend/api/approve_request.php",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ id: testRequest.id }),
              }
            );

            const approveData = await approveResponse.json();

            if (approveResponse.ok && approveData.success) {
              showResult(
                "âœ… Approve Success",
                {
                  message: "Request approved successfully",
                  requestId: testRequest.id,
                  response: approveData,
                },
                true
              );
            } else {
              showResult(
                "âŒ Approve Failed",
                {
                  status: approveResponse.status,
                  response: approveData,
                  requestId: testRequest.id,
                },
                false
              );
            }
          } else {
            showResult(
              "âŒ No Requests Found",
              { message: "No requests available to test" },
              false
            );
          }
        } catch (error) {
          showResult("âŒ Approve Test Error", { error: error.message }, false);
        }
      }

      async function checkRequests() {
        try {
          const response = await fetch(
            "../../backend/api/get_recent_requests.php"
          );
          const data = await response.json();

          if (response.ok && data.success) {
            const statusCounts = {};
            data.requests.forEach((req) => {
              const status = req.status || "(empty)";
              statusCounts[status] = (statusCounts[status] || 0) + 1;
            });

            showResult(
              "ðŸ“Š Request Status Summary",
              {
                totalRequests: data.requests.length,
                statusDistribution: statusCounts,
                sampleRequests: data.requests.slice(0, 3).map((r) => ({
                  id: r.id,
                  status: r.status || "(empty)",
                  document: r.document?.substring(0, 40) + "...",
                })),
              },
              true
            );
          } else {
            showResult(
              "âŒ Failed to Check Requests",
              { status: response.status, data },
              false
            );
          }
        } catch (error) {
          showResult(
            "âŒ Check Requests Error",
            { error: error.message },
            false
          );
        }
      }

      // Auto-run tests on load
      document.addEventListener("DOMContentLoaded", function () {
        setTimeout(() => {
          testLogin();
        }, 1000);

        setTimeout(() => {
          checkRequests();
        }, 2000);
      });
    </script>
  </body>
</html>
