<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Smart Scheduling - Geographic Clustering Analysis</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 1400px;
        margin: 0 auto;
      }
      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 20px;
        text-align: center;
      }
      .test-section {
        background: white;
        padding: 25px;
        margin: 20px 0;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .btn {
        display: inline-block;
        padding: 15px 30px;
        margin: 10px;
        background: #007bff;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        border: none;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.3s;
      }
      .btn:hover {
        background: #0056b3;
        transform: translateY(-2px);
      }
      .btn-success {
        background: #28a745;
      }
      .btn-success:hover {
        background: #1e7e34;
      }
      .btn-warning {
        background: #ffc107;
        color: #212529;
      }
      .btn-warning:hover {
        background: #e0a800;
      }
      .btn-danger {
        background: #dc3545;
      }
      .btn-danger:hover {
        background: #c82333;
      }
      .result-area {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin: 20px 0;
        min-height: 200px;
      }
      .status {
        padding: 15px;
        margin: 15px 0;
        border-radius: 8px;
      }
      .status.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .status.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      .grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }
      .card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }
      .card h3 {
        margin-top: 0;
        color: #333;
      }
      .cluster-info {
        display: flex;
        align-items: center;
        gap: 10px;
        margin: 10px 0;
      }
      .cluster-dot {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: inline-block;
      }
      pre {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        white-space: pre-wrap;
        word-wrap: break-word;
        max-height: 400px;
        overflow-y: auto;
        font-size: 12px;
      }
      .progress-bar {
        width: 100%;
        height: 20px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
      }
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #007bff, #28a745);
        transition: width 0.3s ease;
      }
      .metric {
        text-align: center;
        padding: 15px;
      }
      .metric-value {
        font-size: 2em;
        font-weight: bold;
        color: #007bff;
      }
      .metric-label {
        color: #666;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>üó∫Ô∏è Smart Scheduling - Geographic Clustering Analysis</h1>
        <p>
          Real-time testing of the 2km clustering algorithm with comprehensive
          geographic data
        </p>
      </div>

      <div class="test-section">
        <h2>üöÄ Live Clustering Test</h2>
        <div class="status info">
          <strong>Test Objective:</strong> Analyze how the smart scheduling
          algorithm groups requests within 2km clusters and optimizes driver
          routes across Nairobi.
        </div>

        <div style="text-align: center; margin: 20px 0">
          <input
            type="date"
            id="test-date"
            value="2025-07-26"
            style="
              padding: 10px;
              border-radius: 5px;
              border: 1px solid #ddd;
              margin-right: 10px;
            "
          />
          <button class="btn btn-success" onclick="runFullTest()">
            üß™ Run Complete Clustering Test
          </button>
          <button class="btn" onclick="generateSchedule()">
            üöÄ Generate Schedule
          </button>
          <button class="btn btn-warning" onclick="viewCurrentSchedule()">
            üëÅÔ∏è View Schedule
          </button>
        </div>
      </div>

      <div class="test-section">
        <h2>üìä Test Progress & Results</h2>
        <div id="progress-section">
          <div class="progress-bar">
            <div
              class="progress-fill"
              id="progress-fill"
              style="width: 0%"
            ></div>
          </div>
          <div id="progress-text">Ready to start test...</div>
        </div>
        <div id="test-results" class="result-area">
          <div style="text-align: center; color: #666; font-style: italic">
            Click "Run Complete Clustering Test" to begin analysis...
          </div>
        </div>
      </div>

      <div class="test-section">
        <h2>üìà Algorithm Performance Metrics</h2>
        <div class="grid">
          <div class="card">
            <div class="metric">
              <div class="metric-value" id="total-requests">-</div>
              <div class="metric-label">Total Requests</div>
            </div>
          </div>
          <div class="card">
            <div class="metric">
              <div class="metric-value" id="clusters-formed">-</div>
              <div class="metric-label">Geographic Clusters</div>
            </div>
          </div>
          <div class="card">
            <div class="metric">
              <div class="metric-value" id="drivers-assigned">-</div>
              <div class="metric-label">Drivers Assigned</div>
            </div>
          </div>
          <div class="card">
            <div class="metric">
              <div class="metric-value" id="efficiency-score">-</div>
              <div class="metric-label">Efficiency Score</div>
            </div>
          </div>
        </div>
      </div>

      <div class="test-section">
        <h2>üó∫Ô∏è Cluster Visualization</h2>
        <div id="cluster-visualization">
          <div
            style="
              text-align: center;
              color: #666;
              font-style: italic;
              padding: 40px;
            "
          >
            Run the clustering test to see geographic distribution analysis...
          </div>
        </div>
      </div>
    </div>

    <script>
      let testProgress = 0;
      let testResults = {};

      function updateProgress(percent, text) {
        document.getElementById("progress-fill").style.width = percent + "%";
        document.getElementById("progress-text").textContent = text;
      }

      function showResults(title, data, type = "info") {
        const resultsDiv = document.getElementById("test-results");
        const timestamp = new Date().toLocaleTimeString();

        const resultHtml = `
                <div class="status ${type}" style="margin-bottom: 15px;">
                    <strong>[${timestamp}] ${title}</strong>
                    <details style="margin-top: 10px;">
                        <summary>View Details</summary>
                        <pre>${JSON.stringify(data, null, 2)}</pre>
                    </details>
                </div>
            `;

        resultsDiv.innerHTML = resultHtml + resultsDiv.innerHTML;
      }

      function updateMetrics(metrics) {
        document.getElementById("total-requests").textContent =
          metrics.totalRequests || "-";
        document.getElementById("clusters-formed").textContent =
          metrics.clustersFormed || "-";
        document.getElementById("drivers-assigned").textContent =
          metrics.driversAssigned || "-";
        document.getElementById("efficiency-score").textContent =
          (metrics.efficiencyScore || 0) + "%";
      }

      function visualizeClusters(schedules) {
        const visualization = document.getElementById("cluster-visualization");

        if (!schedules || schedules.length === 0) {
          visualization.innerHTML =
            '<div style="text-align: center; color: #666;">No clusters to visualize</div>';
          return;
        }

        const colors = [
          "#007bff",
          "#28a745",
          "#dc3545",
          "#ffc107",
          "#6f42c1",
          "#fd7e14",
          "#20c997",
          "#e83e8c",
        ];

        let html = '<div class="grid">';

        schedules.forEach((schedule, index) => {
          const color = colors[index % colors.length];
          const requests = schedule.assignments || schedule.requests || [];

          html += `
                    <div class="card">
                        <div class="cluster-info">
                            <div class="cluster-dot" style="background: ${color};"></div>
                            <strong>Cluster ${index + 1}: ${
            schedule.driver_name ||
            schedule.driver?.username ||
            "Driver " + (index + 1)
          }</strong>
                        </div>
                        <div><strong>Requests:</strong> ${requests.length}</div>
                        <div><strong>Total Volume:</strong> ${
                          schedule.total_volume || 0
                        }m¬≥</div>
                        <div><strong>Time Span:</strong> ${
                          schedule.start_time || "08:00"
                        } - ${schedule.end_time || "17:00"}</div>
                        <div style="margin-top: 10px;">
                            <strong>Locations:</strong>
                            <ul style="font-size: 12px; margin: 5px 0; padding-left: 20px;">
                                ${requests
                                  .slice(0, 5)
                                  .map(
                                    (req) =>
                                      `<li>${
                                        req.pickup_location ||
                                        req.document ||
                                        "Location"
                                      }</li>`
                                  )
                                  .join("")}
                                ${
                                  requests.length > 5
                                    ? `<li style="font-style: italic;">... and ${
                                        requests.length - 5
                                      } more</li>`
                                    : ""
                                }
                            </ul>
                        </div>
                    </div>
                `;
        });

        html += "</div>";
        visualization.innerHTML = html;
      }

      async function runFullTest() {
        updateProgress(10, "Starting comprehensive clustering test...");
        showResults(
          "üöÄ Test Started",
          { message: "Beginning full clustering analysis" },
          "info"
        );

        try {
          // Step 1: Generate schedule
          updateProgress(30, "Generating optimized schedule...");
          const generateResult = await generateSchedule(false);

          if (generateResult && generateResult.success) {
            updateProgress(60, "Analyzing geographic clusters...");
            showResults("‚úÖ Schedule Generated", generateResult, "success");

            // Update metrics
            updateMetrics({
              totalRequests: generateResult.total_requests,
              driversAssigned: generateResult.drivers_used,
              clustersFormed: generateResult.schedules
                ? generateResult.schedules.length
                : 0,
              efficiencyScore: Math.round(
                (generateResult.drivers_used /
                  (generateResult.total_requests / 10)) *
                  100
              ),
            });

            // Visualize clusters
            visualizeClusters(generateResult.schedules);

            updateProgress(90, "Verifying schedule accuracy...");

            // Step 2: View and verify
            const viewResult = await viewCurrentSchedule(false);
            if (viewResult && viewResult.success) {
              updateProgress(100, "Test completed successfully!");
              showResults(
                "‚úÖ Clustering Analysis Complete",
                {
                  clustersIdentified: viewResult.schedules.length,
                  totalAssignments: viewResult.schedules.reduce(
                    (sum, s) => sum + (s.assignments?.length || 0),
                    0
                  ),
                  algorithmEfficiency: "High - Geographic clustering active",
                },
                "success"
              );
            }
          } else {
            updateProgress(0, "Test failed - check results below");
            showResults("‚ùå Test Failed", generateResult, "error");
          }
        } catch (error) {
          updateProgress(0, "Test failed with error");
          showResults("‚ùå Test Error", { error: error.message }, "error");
        }
      }

      async function generateSchedule(showResult = true) {
        const date = document.getElementById("test-date").value;

        try {
          const response = await fetch(
            `../../backend/api/smart_scheduling.php?action=generate&date=${date}`
          );
          const data = await response.json();

          if (showResult) {
            if (data.success) {
              showResults("üöÄ Schedule Generated", data, "success");
              updateMetrics({
                totalRequests: data.total_requests,
                driversAssigned: data.drivers_used,
                clustersFormed: data.schedules ? data.schedules.length : 0,
                efficiencyScore: Math.round(
                  (data.drivers_used / (data.total_requests / 10)) * 100
                ),
              });
              visualizeClusters(data.schedules);
            } else {
              showResults("‚ùå Generation Failed", data, "error");
            }
          }

          return data;
        } catch (error) {
          if (showResult) {
            showResults("‚ùå Network Error", { error: error.message }, "error");
          }
          throw error;
        }
      }

      async function viewCurrentSchedule(showResult = true) {
        const date = document.getElementById("test-date").value;

        try {
          const response = await fetch(
            `../../backend/api/smart_scheduling.php?action=view&date=${date}`
          );
          const data = await response.json();

          if (showResult) {
            if (data.success && data.schedules.length > 0) {
              showResults("üëÅÔ∏è Schedule Retrieved", data, "success");
              visualizeClusters(data.schedules);

              const totalAssignments = data.schedules.reduce(
                (sum, s) => sum + (s.assignments?.length || 0),
                0
              );
              updateMetrics({
                totalRequests: totalAssignments,
                driversAssigned: data.schedules.length,
                clustersFormed: data.schedules.length,
                efficiencyScore: Math.round(
                  (data.schedules.length / (totalAssignments / 10)) * 100
                ),
              });
            } else {
              showResults(
                "‚ÑπÔ∏è No Schedule Found",
                { message: "No schedule exists for this date" },
                "info"
              );
            }
          }

          return data;
        } catch (error) {
          if (showResult) {
            showResults("‚ùå Network Error", { error: error.message }, "error");
          }
          throw error;
        }
      }

      // Initialize on load
      document.addEventListener("DOMContentLoaded", function () {
        showResults(
          "üß™ Clustering Analysis Ready",
          {
            message: "Ready to test geographic clustering algorithm",
            testDate: document.getElementById("test-date").value,
          },
          "info"
        );
      });
    </script>
  </body>
</html>
